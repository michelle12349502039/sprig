/*
First time? Check out the tutorial game:
https://sprig.hackclub.com/gallery/getting_started

@title: Simple Pac-Man
@author: Your Name
@tags: []
@addedOn: 2024-07-11
*/

const player = "p"
const walltop = "t"
const wallside = "s"
const dot = "d"
const ghostA = "A"
const ghostB = "B"
const ghostC = "C"
const biggerdot = "L"
const fruit = "f"

setLegend(
  [ player, bitmap`
0000000000000000
0000000000000000
0000066666600000
0006666666666000
0006666666666000
0066666666660000
0066666666600000
0066666660000000
0066666600000000
0066666666000000
0066666666660000
0006666666666000
0006666666666000
0000066666600000
0000000000000000
0000000000000000` ],
  [ walltop, bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
5555555555555555
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
5555555555555555
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000` ],
  [ wallside, bitmap`
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000
0000500000500000` ],
  [ dot, bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000006660000000
0000006660000000
0000006660000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000` ],
  [ ghostA, bitmap`
0000000000000000
0000003333300000
0000333333330000
0003333333333000
0003333333333300
0035522355223300
0035522355223300
0032223322233300
0033333333333300
0033333333333300
0033333333333300
0033333333333300
0033333333333300
0033033330003300
0030000330000300
0000000000000000` ],
  [ ghostB, bitmap`
0000000000000000
0000007777700000
0000777777770000
0007777777777000
0007777777777700
0075522755227700
0075522755227700
0072227722277700
0077777777777700
0077777777777700
0077777777777700
0077777777777700
0077777777777700
0077077770007700
0070000770000700
0000000000000000` ],
  [ ghostC, bitmap`
0000000000000000
0000008888800000
0000888888880000
0008888888888000
0008888888888800
0085522855228800
0085522855228800
0082228822288800
0088888888888800
0088888888888800
0088888888888800
0088888888888800
0088888888888800
0088088880008800
0080000880000800
0000000000000000` ],
  [ biggerdot, bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000666666660000
0000666666660000
0000666666660000
0000666666660000
0000666666660000
0000666666660000
0000666666660000
0000666666660000
0000000000000000
0000000000000000
0000000000000000
0000000000000000` ],
  [ fruit, bitmap`
0000000000000000
00000000D0000000
00000000D0000000
0000000DDD000000
000000DDDD000000
00000DD0DD000000
00000D000DD00000
0000DD000D330000
0003333003333000
0033333033333300
0033333033333300
0033333033333300
0003333003333000
0000000000000000
0000000000000000
0000000000000000` ]
)

setSolids([player, walltop,wallside])

let level = 0
const levels = [
  map`
sttttttttttttts
spdddddddddddAs
sddddtttttdddds
sddtddddddtddds
sddLdtttttdddds
sddtddddddtddds
sddddddddLddtts
sttttttttttttts`
]

setMap(levels[level])


setPushables({
  [ player ]: []
})

onInput("w", () => {
  getFirst(player).y -= 1
})

onInput("a", () => {
  getFirst(player).x -= 1
})

onInput("s", () => {
  getFirst(player).y += 1
})

onInput("d", () => {
  getFirst(player).x += 1
})

let score = 0
let lives = 3

function checkCollision() {
  const playerPos = getFirst(player)
  const tileContent = getTile(playerPos.x, playerPos.y)
  if (tileContent.includes(dot)) {
    score++
    clearTile(playerPos.x, playerPos.y)
  }
  if (tileContent.includes(biggerdot)) {
    score += 10
    clearTile(playerPos.x, playerPos.y)
  }
  if (tileContent.includes(fruit)) {
    score += 50
    clearTile(playerPos.x, playerPos.y)
  }
  if (tileContent.includes(ghostA) || tileContent.includes(ghostB) || tileContent.includes(ghostC)) {
    lives--
    if (lives <= 0) {
      addText("Game Over!", { y: 4, color: color`3` })
      score = 0
      lives = 3
      setMap(levels[level])
    }
  }
}

function moveGhosts() {
  const ghosts = getAll(ghostA).concat(getAll(ghostB), getAll(ghostC))
  ghosts.forEach(g => {
    const direction = Math.floor(Math.random() * 4)
    switch (direction) {
      case 0: g.y -= 1; break;
      case 1: g.x += 1; break;
      case 2: g.y += 1; break;
      case 3: g.x -= 1; break;
    }
  })
}

afterInput(() => {
  checkCollision()
  moveGhosts()
})
